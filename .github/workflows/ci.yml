name: ci

on:
  push:
  pull_request:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Stage 1 (editable)
        run: |
          python -m pip install -U pip
          python -m pip install -e stage1_dataset
          python -m pip install ruff

      - name: Lint
        run: |
          ruff check .
          ruff format --check .

      - name: Smoke test CLI help
        run: |
          fly-olf-stage1 --help

  readme-policy:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fail if code changed but README not updated
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed.txt
          if grep -E "(stage1_dataset/src/|scripts/|\\.github/workflows/)" -q changed.txt; then
            if ! grep -q "README.md" changed.txt; then
              echo "Code changed but README.md not updated. Please update README usage/notes."
              exit 1
            fi
          fi
